################ OpenSearch #####################

## Node 01
hostnamectl set-hostname opensearch01 && sudo su -
hostnamectl set-hostname opensearch02 && sudo su -
hostnamectl set-hostname opensearch03 && sudo su -

cat << EOF >> vi /etc/hosts
10.0.2.31 opensearch01
10.0.2.32 opensearch02
10.0.2.33 opensearch03
EOF

groupadd -g 1001 cmpprod
useradd -m -g 1001 -u 1001 -c cmpprod -s /bin/bash cmpprod
touch /home/cmpprod/.rhosts
echo "export TMOUT=1800" >> /home/cmpprod/.bash_profile
echo "umask 0022" >> /home/cmpprod/.bash_profile
echo "cmpprod ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/cmpprod
echo 'cmpprod:12345a@' | sudo chpasswd

cat << EOF >> vi /etc/sysctl.conf
vm.max_map_count=262144
EOF

cat << EOF >> /etc/security/limits.conf
cmpprod soft nofile 65536
cmpprod hard nofile 65536
EOF
sudo sysctl -p

sudo mkdir -p /data/opensearch
sudo mkdir -p /data/logs/opensearch
sudo chown -R cmpprod.cmpprod /data

cat << EOF >> /home/cmpprod/.bash_profile
export OPENSEARCH_JAVA_HOME=/home/cmpprod/opensearch/jdk
EOF

cat << EOF >> /etc/systemd/system/opensearch.service
[Unit]
Description=Opensearch
Documentation=https://opensearch.org/docs/latest
Requires=network.target remote-fs.target
After=network.target remote-fs.target
ConditionPathExists=/home/cmpprod/opensearch

[Service]
User=cmpprod
Group=cmpprod
WorkingDirectory=/home/cmpprod/opensearch
ExecStart=/home/cmpprod/opensearch/bin/opensearch

LimitNOFILE=65535
LimitNPROC=4096
LimitAS=infinity
LimitFSIZE=infinity
TimeoutStopSec=0
KillSignal=SIGTERM
KillMode=process
SendSIGKILL=no
SuccessExitStatus=143
TimeoutStartSec=75
[Install]
WantedBy=multi-user.target
EOF
sudo systemctl daemon-reload

mkdir -p /data/opensearch
mkdir -p /data/logs/opensearch
chown -R cmpprod:cmpprod /data

sudo su - cmpprod
tar -xvf /tmp/opensearch-2.11.1-linux-x64.tar.gz -C /home/cmpprod/
ln -s /home/cmpprod/opensearch-2.11.1/ /home/cmpprod/opensearch
mkdir -p /home/cmpprod/opensearch/config/certs

#JVM Config

#Cert Config
cat << EOF >> /home/cmpprod/opensearch/config/certs/certs.sh
#!/bin/sh
# Root CA
openssl genrsa -out root-ca-key.pem 2048
openssl req -new -x509 -sha256 -key root-ca-key.pem -subj "/C=CA/ST=ONTARIO/L=TORONTO/O=ORG/OU=UNIT/CN=ROOT" -out root-ca.pem -days 730
# Admin cert
openssl genrsa -out admin-key-temp.pem 2048
openssl pkcs8 -inform PEM -outform PEM -in admin-key-temp.pem -topk8 -nocrypt -v1 PBE-SHA1-3DES -out admin-key.pem
openssl req -new -key admin-key.pem -subj "/C=CA/ST=ONTARIO/L=TORONTO/O=ORG/OU=UNIT/CN=ADMIN" -out admin.csr
openssl x509 -req -in admin.csr -CA root-ca.pem -CAkey root-ca-key.pem -CAcreateserial -sha256 -out admin.pem -days 730
# Node cert 1
openssl genrsa -out opensearch01-key-temp.pem 2048
openssl pkcs8 -inform PEM -outform PEM -in opensearch01-key-temp.pem -topk8 -nocrypt -v1 PBE-SHA1-3DES -out opensearch01-key.pem
openssl req -new -key opensearch01-key.pem -subj "/C=CA/ST=ONTARIO/L=TORONTO/O=ORG/OU=UNIT/CN=opensearch01" -out opensearch01.csr
openssl x509 -req -in opensearch01.csr -CA root-ca.pem -CAkey root-ca-key.pem -CAcreateserial -sha256 -out opensearch01.pem -days 730
# Node cert 2
openssl genrsa -out opensearch02-key-temp.pem 2048
openssl pkcs8 -inform PEM -outform PEM -in opensearch02-key-temp.pem -topk8 -nocrypt -v1 PBE-SHA1-3DES -out opensearch02-key.pem
openssl req -new -key opensearch02-key.pem -subj "/C=CA/ST=ONTARIO/L=TORONTO/O=ORG/OU=UNIT/CN=opensearch02" -out opensearch02.csr
openssl x509 -req -in opensearch02.csr -CA root-ca.pem -CAkey root-ca-key.pem -CAcreateserial -sha256 -out opensearch02.pem -days 730
# Node cert 3
openssl genrsa -out opensearch03-key-temp.pem 2048
openssl pkcs8 -inform PEM -outform PEM -in opensearch03-key-temp.pem -topk8 -nocrypt -v1 PBE-SHA1-3DES -out opensearch03-key.pem
openssl req -new -key opensearch03-key.pem -subj "/C=CA/ST=ONTARIO/L=TORONTO/O=ORG/OU=UNIT/CN=opensearch03" -out opensearch03.csr
openssl x509 -req -in opensearch03.csr -CA root-ca.pem -CAkey root-ca-key.pem -CAcreateserial -sha256 -out opensearch03.pem -days 730
# Client cert
openssl genrsa -out client-key-temp.pem 2048
openssl pkcs8 -inform PEM -outform PEM -in client-key-temp.pem -topk8 -nocrypt -v1 PBE-SHA1-3DES -out client-key.pem
openssl req -new -key client-key.pem -subj "/C=CA/ST=ONTARIO/L=TORONTO/O=ORG/OU=UNIT/CN=CLIENT" -out client.csr
openssl x509 -req -in client.csr -CA root-ca.pem -CAkey root-ca-key.pem -CAcreateserial -sha256 -out client.pem -days 730
# Cleanup
rm admin-key-temp.pem
rm admin.csr
rm opensearch01-key-temp.pem
rm opensearch01.csr
rm opensearch02-key-temp.pem
rm opensearch02.csr
rm opensearch03-key-temp.pem
rm opensearch03.csr
rm client-key-temp.pem
rm client.csr
EOF

cd /home/cmpprod/opensearch/config/certs && sh certs.sh
mv /home/cmpprod/opensearch/config/opensearch.yml /home/cmpprod/opensearch/config/opensearch.yml.bak

sshpass -p '12345a@' scp -o StrictHostKeyChecking=no /home/cmpprod/opensearch/config/certs/* cmpprod@opensearch02:/home/cmpprod/opensearch/config/certs/
sshpass -p '12345a@' scp -o StrictHostKeyChecking=no /home/cmpprod/opensearch/config/certs/* cmpprod@opensearch03:/home/cmpprod/opensearch/config/certs/

#Node 1
cat << EOF >> /home/cmpprod/opensearch/config/opensearch.yml
cluster.name: opensearch-cluster
node.name: opensearch01
node.roles: [ master, data]
network.host: 0.0.0.0
path.data: /data/opensearch
path.logs: /data/logs/opensearch
discovery.seed_hosts: ["opensearch01", "opensearch02", "opensearch03"]
cluster.initial_master_nodes: ["opensearch01", "opensearch02", "opensearch03"]

plugins.security.ssl.transport.pemcert_filepath: /home/cmpprod/opensearch/config/certs/opensearch01.pem
plugins.security.ssl.transport.pemkey_filepath: /home/cmpprod/opensearch/config/certs/opensearch01-key.pem
plugins.security.ssl.transport.pemtrustedcas_filepath: /home/cmpprod/opensearch/config/certs/root-ca.pem
plugins.security.ssl.transport.enforce_hostname_verification: false
plugins.security.ssl.http.enabled: true
plugins.security.ssl.http.pemcert_filepath: /home/cmpprod/opensearch/config/certs/opensearch01.pem
plugins.security.ssl.http.pemkey_filepath: /home/cmpprod/opensearch/config/certs/opensearch01-key.pem
plugins.security.ssl.http.pemtrustedcas_filepath: /home/cmpprod/opensearch/config/certs/root-ca.pem
plugins.security.authcz.admin_dn:
  - 'CN=ADMIN,OU=UNIT,O=ORG,L=TORONTO,ST=ONTARIO,C=CA'
plugins.security.nodes_dn:
  - 'CN=opensearch01,OU=UNIT,O=ORG,L=TORONTO,ST=ONTARIO,C=CA'
  - 'CN=opensearch02,OU=UNIT,O=ORG,L=TORONTO,ST=ONTARIO,C=CA'
  - 'CN=opensearch03,OU=UNIT,O=ORG,L=TORONTO,ST=ONTARIO,C=CA'
EOF

#Node 2
cat << EOF >> /home/cmpprod/opensearch/config/opensearch.yml
cluster.name: opensearch-cluster
node.name: opensearch02
node.roles: [ master, data]
network.host: 0.0.0.0
path.data: /data/opensearch
path.logs: /data/logs/opensearch
discovery.seed_hosts: ["opensearch01", "opensearch02", "opensearch03"]
cluster.initial_master_nodes: ["opensearch01", "opensearch02", "opensearch03"]

plugins.security.ssl.transport.pemcert_filepath: /home/cmpprod/opensearch/config/certs/opensearch02.pem
plugins.security.ssl.transport.pemkey_filepath: /home/cmpprod/opensearch/config/certs/opensearch02-key.pem
plugins.security.ssl.transport.pemtrustedcas_filepath: /home/cmpprod/opensearch/config/certs/root-ca.pem
plugins.security.ssl.transport.enforce_hostname_verification: false
plugins.security.ssl.http.enabled: true
plugins.security.ssl.http.pemcert_filepath: /home/cmpprod/opensearch/config/certs/opensearch02.pem
plugins.security.ssl.http.pemkey_filepath: /home/cmpprod/opensearch/config/certs/opensearch02-key.pem
plugins.security.ssl.http.pemtrustedcas_filepath: /home/cmpprod/opensearch/config/certs/root-ca.pem
plugins.security.authcz.admin_dn:
  - 'CN=ADMIN,OU=UNIT,O=ORG,L=TORONTO,ST=ONTARIO,C=CA'
plugins.security.nodes_dn:
  - 'CN=opensearch01,OU=UNIT,O=ORG,L=TORONTO,ST=ONTARIO,C=CA'
  - 'CN=opensearch02,OU=UNIT,O=ORG,L=TORONTO,ST=ONTARIO,C=CA'
  - 'CN=opensearch03,OU=UNIT,O=ORG,L=TORONTO,ST=ONTARIO,C=CA'
EOF

#Node 3
cat << EOF >> /home/cmpprod/opensearch/config/opensearch.yml
cluster.name: opensearch-cluster
node.name: opensearch03
node.roles: [ master, data]
network.host: 0.0.0.0
path.data: /data/opensearch
path.logs: /data/logs/opensearch
discovery.seed_hosts: ["opensearch01", "opensearch02", "opensearch03"]
cluster.initial_master_nodes: ["opensearch01", "opensearch02", "opensearch03"]

plugins.security.ssl.transport.pemcert_filepath: /home/cmpprod/opensearch/config/certs/opensearch03.pem
plugins.security.ssl.transport.pemkey_filepath: /home/cmpprod/opensearch/config/certs/opensearch03-key.pem
plugins.security.ssl.transport.pemtrustedcas_filepath: /home/cmpprod/opensearch/config/certs/root-ca.pem
plugins.security.ssl.transport.enforce_hostname_verification: false
plugins.security.ssl.http.enabled: true
plugins.security.ssl.http.pemcert_filepath: /home/cmpprod/opensearch/config/certs/opensearch03.pem
plugins.security.ssl.http.pemkey_filepath: /home/cmpprod/opensearch/config/certs/opensearch03-key.pem
plugins.security.ssl.http.pemtrustedcas_filepath: /home/cmpprod/opensearch/config/certs/root-ca.pem
plugins.security.authcz.admin_dn:
  - 'CN=ADMIN,OU=UNIT,O=ORG,L=TORONTO,ST=ONTARIO,C=CA'
plugins.security.nodes_dn:
  - 'CN=opensearch01,OU=UNIT,O=ORG,L=TORONTO,ST=ONTARIO,C=CA'
  - 'CN=opensearch02,OU=UNIT,O=ORG,L=TORONTO,ST=ONTARIO,C=CA'
  - 'CN=opensearch03,OU=UNIT,O=ORG,L=TORONTO,ST=ONTARIO,C=CA'
EOF


sudo systemctl start opensearch.service
sudo systemctl enable opensearch.service
systemctl status opensearch.service


##Run SecurityAdmin
chmod 755 /home/cmpprod/opensearch/plugins/opensearch-security/tools/*.sh
/home/cmpprod/opensearch/plugins/opensearch-security/tools/securityadmin.sh -cd /home/cmpprod/opensearch/plugins/opensearch-security -icl -nhnv \
  -cacert /home/cmpprod/opensearch/config/certs/root-ca.pem \
  -cert /home/cmpprod/opensearch/config/certs/admin.pem \
  -key /home/cmpprod/opensearch/config/certs/admin-key.pem

# Add trust
sudo cp /home/cmpprod/opensearch/config/certs/root-ca.pem /etc/pki/ca-trust/source/anchors/
sudo update-ca-trust

##Verify
curl -XGET https://$HOSTNAME:9200/_cluster/health?pretty -u 'admin:admin'
curl -XGET https://$HOSTNAME:9200/_cat/plugins?v -u 'admin:admin'
curl -XGET https://$HOSTNAME:9200/ -u 'admin:admin'
curl -XGET https://$HOSTNAME:9200/_cat/nodes?v -u 'admin:admin'
curl -XGET https://$HOSTNAME:9200/_cluster/state?pretty -u 'admin:admin'


##Dashboard
tar -zxf /tmp/opensearch-dashboards-2.11.1-linux-x64.tar.gz -C /home/cmpprod
ln -s /home/cmpprod/opensearch-dashboards-2.11.1 /home/cmpprod/dashboards

cat << EOF >>/etc/systemd/system/opensearch-dashboard.service
[Unit]
Description=OpenSearch Dashboard
Documentation=https://opensearch-dashboards.com/
[Service]
ExecStart=/home/cmpprod/dashboards/bin/opensearch-dashboards
WorkingDirectory=/home/cmpprod/dashboards
User=cmpprod
Group=cmpprod
Restart=always
[Install]
WantedBy=multi-user.target
EOF
sudo systemctl daemon-reload

mv /home/cmpprod/dashboards/config/opensearch_dashboards.yml /home/cmpprod/dashboards/config/opensearch_dashboards.yml.bak

cat << EOF >> /home/cmpprod/dashboards/config/opensearch_dashboards.yml
opensearch.hosts: ["https://opensearch02:9200", "https://opensearch02:9200", "https://opensearch03:9200"]
opensearch.ssl.certificateAuthorities: ["/path/to/root-ca.crt"]
opensearch.ssl.certificate: "/path/to/opensearch-dashboards.crt"
opensearch.ssl.key: "/path/to/opensearch-dashboards.key"
opensearch.ssl.keyPassphrase: "your_key_passphrase"
server.host: "0.0.0.0"
server.ssl.enabled: true
server.ssl.certificate: "/path/to/opensearch-dashboards.crt"
server.ssl.key: "/path/to/opensearch-dashboards.key"
opensearch_security.ssl.verificationMode: none
opensearch_security.ssl.enabled: true
opensearch_security.ssl.certificate: "/path/to/opensearch-dashboards.crt"
opensearch_security.ssl.key: "/path/to/opensearch-dashboards.key"
opensearch_security.ssl.certificateAuthorities: ["/path/to/root-ca.crt"]
opensearch_security.ssl.keyPassphrase: "your_key_passphrase"
EOF

sudo systemctl start opensearch-dashboard.service
sudo systemctl status opensearch-dashboard.service
sudo systemctl restart opensearch-dashboard